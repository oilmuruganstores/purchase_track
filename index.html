<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Oil Murugan Stores | Smart Intelligence</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://fonts.googleapis.com/css2?family=Plus+Jakarta+Sans:wght@300;400;500;600;700;800&display=swap" rel="stylesheet">
    <script src="https://unpkg.com/@phosphor-icons/web"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>

    <style>
        body { background-color: #F8FAFC; font-family: 'Plus Jakarta Sans', sans-serif; color: #0F172A; }
        .tab-content { display: none; }
        .tab-content.active { display: block; animation: slideUp 0.4s cubic-bezier(0, 0, 0.2, 1); }
        @keyframes slideUp { from { opacity: 0; transform: translateY(20px); } to { opacity: 1; transform: translateY(0); } }
        .nav-item.active { background: #1E293B; color: #FFFFFF; box-shadow: 0 10px 15px -3px rgba(0, 0, 0, 0.1); }
        .card-shadow { box-shadow: 0 1px 3px 0 rgba(0, 0, 0, 0.1), 0 1px 2px -1px rgba(0, 0, 0, 0.1); }
        .tf-btn.active { background: white; box-shadow: 0 1px 2px rgba(0,0,0,0.1); color: #2563eb; }
        .insight-card { transition: all 0.3s ease; }
        .insight-card:hover { transform: translateY(-5px); }
        .scroll-hide::-webkit-scrollbar { display: none; }
    </style>
</head>
<body class="h-screen flex flex-col md:flex-row overflow-hidden text-slate-900">

    <!-- Sidebar -->
    <aside class="w-full md:w-72 bg-white border-r border-slate-200 flex flex-col z-30">
        <div class="p-8">
            <h1 class="text-2xl font-black tracking-tighter text-slate-900 leading-tight">
                OIL MURUGAN <br>
                <span class="text-blue-600">STORES</span>
            </h1>
        </div>

        <nav class="flex-1 px-4 space-y-1">
            <button onclick="switchTab('dashboard')" id="btn-dashboard" class="nav-item active w-full flex items-center gap-3 px-5 py-4 rounded-2xl font-bold transition-all">
                <i class="ph ph-squares-four text-xl"></i> Dashboard
            </button>
            <button onclick="switchTab('purchase')" id="btn-purchase" class="nav-item w-full flex items-center gap-3 px-5 py-4 rounded-2xl font-bold transition-all text-slate-500 hover:bg-slate-50">
                <i class="ph ph-plus-circle text-xl"></i> New Entry
            </button>
            <button onclick="switchTab('history')" id="btn-history" class="nav-item w-full flex items-center gap-3 px-5 py-4 rounded-2xl font-bold transition-all text-slate-500 hover:bg-slate-50">
                <i class="ph ph-clock-counter-clockwise text-xl"></i> History
            </button>
            <button onclick="switchTab('analytics')" id="btn-analytics" class="nav-item w-full flex items-center gap-3 px-5 py-4 rounded-2xl font-bold transition-all text-slate-500 hover:bg-slate-50">
                <i class="ph ph-chart-line-up text-xl"></i> Smart Insights
            </button>
        </nav>

        <div class="p-6">
            <div class="bg-blue-600 rounded-2xl p-5 text-white">
                <p class="text-[10px] font-black uppercase opacity-70 mb-1">Local Storage</p>
                <p class="text-xs font-bold">Data is saved locally on this browser.</p>
            </div>
        </div>
    </aside>

    <!-- Main Content -->
    <main class="flex-1 overflow-y-auto p-4 md:p-10">
        <!-- Toast Notification -->
        <div id="toast" class="fixed top-8 right-8 bg-slate-900 text-white px-6 py-4 rounded-2xl shadow-2xl transform translate-x-[200%] transition-transform duration-500 z-50 flex items-center gap-3">
            <i class="ph ph-check-circle text-green-400 text-xl"></i>
            <span id="toast-msg" class="font-bold text-sm">Success</span>
        </div>

        <!-- DASHBOARD (Standard Metrics) -->
        <div id="dashboard" class="tab-content active max-w-6xl mx-auto space-y-8">
            <header>
                <h2 class="text-3xl font-extrabold tracking-tight">Financial Pulse</h2>
                <p class="text-slate-400 font-medium">Daily overview of operations.</p>
            </header>

            <div class="grid grid-cols-1 md:grid-cols-3 gap-6">
                <div class="bg-white p-6 rounded-3xl border border-slate-100 card-shadow">
                    <p class="text-[10px] font-black text-slate-400 uppercase tracking-widest mb-1">Total Procurement</p>
                    <h3 class="text-3xl font-black" id="dash-total-buy">₹0</h3>
                </div>
                <div class="bg-orange-50 p-6 rounded-3xl border border-orange-100">
                    <p class="text-[10px] font-black text-orange-400 uppercase tracking-widest mb-1">Active Dues</p>
                    <h3 class="text-3xl font-black text-orange-600" id="dash-total-dues">₹0</h3>
                </div>
                <div class="bg-blue-50 p-6 rounded-3xl border border-blue-100">
                    <p class="text-[10px] font-black text-blue-400 uppercase tracking-widest mb-1">Growth Index</p>
                    <h3 class="text-3xl font-black text-blue-700" id="dash-growth-index">--</h3>
                </div>
            </div>

            <div class="grid grid-cols-1 lg:grid-cols-2 gap-8">
                <div class="space-y-4">
                    <h4 class="text-xs font-black uppercase text-slate-400 tracking-widest">Immediate Requirements</h4>
                    <div id="requirement-list" class="space-y-3"></div>
                </div>
                <div class="space-y-4">
                    <h4 class="text-xs font-black uppercase text-slate-400 tracking-widest">Recent Activity</h4>
                    <div id="recent-list" class="space-y-3"></div>
                </div>
            </div>
        </div>

        <!-- NEW ENTRY -->
        <div id="purchase" class="tab-content max-w-3xl mx-auto">
            <header class="mb-8">
                <h2 class="text-3xl font-extrabold tracking-tight">Log Purchase</h2>
            </header>
            <form id="purchase-form" onsubmit="event.preventDefault(); handlePurchaseSubmit();" class="bg-white rounded-[2rem] p-8 border border-slate-100 card-shadow space-y-6">
                <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
                    <div class="space-y-1">
                        <label class="text-[10px] font-black uppercase text-slate-400 tracking-widest">Supplier Name</label>
                        <input type="text" id="p-supplier" list="supplier-list" class="w-full px-5 py-3 bg-slate-50 rounded-xl outline-none font-bold" placeholder="Vendor" required>
                        <datalist id="supplier-list"></datalist>
                    </div>
                    <div class="space-y-1">
                        <label class="text-[10px] font-black uppercase text-slate-400 tracking-widest">Category</label>
                        <select id="p-category" class="w-full px-5 py-3 bg-slate-50 rounded-xl outline-none font-bold">
                            <option>Pulses & Dals</option><option>Grains & Rice</option><option>Oil & Ghee</option>
                            <option>Spices & Masala</option><option>Sugar & Jaggery</option><option>FMCG</option>
                        </select>
                    </div>
                </div>
                <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
                    <div class="space-y-1">
                        <label class="text-[10px] font-black uppercase text-slate-400 tracking-widest">Bill Date</label>
                        <input type="date" id="p-date" class="w-full px-5 py-3 bg-slate-50 rounded-xl outline-none font-bold" required>
                    </div>
                    <div class="space-y-1">
                        <label class="text-[10px] font-black uppercase text-slate-400 tracking-widest">Total Bill (₹)</label>
                        <input type="number" id="p-total" class="w-full px-5 py-3 bg-slate-50 rounded-xl outline-none font-black text-blue-600 text-xl" placeholder="0.00" step="0.01" required>
                    </div>
                </div>
                <div class="p-6 bg-slate-50 rounded-2xl border border-slate-200 grid grid-cols-2 gap-4">
                    <div class="space-y-1">
                        <label class="text-[10px] font-bold text-slate-400 uppercase tracking-widest">Advance Paid</label>
                        <input type="number" id="p-paid" class="w-full px-4 py-2 bg-white rounded-lg font-bold" placeholder="0.00">
                    </div>
                    <div class="space-y-1">
                        <label class="text-[10px] font-bold text-slate-400 uppercase tracking-widest">Mode</label>
                        <select id="p-mode" class="w-full px-4 py-2 bg-white rounded-lg font-bold">
                            <option>Cash</option><option>UPI</option><option>Bank</option>
                        </select>
                    </div>
                </div>
                <button type="submit" class="w-full py-4 bg-blue-600 text-white rounded-2xl font-black text-lg hover:bg-blue-700 shadow-xl transition-all">
                    Save Record
                </button>
            </form>
        </div>

        <!-- HISTORY -->
        <div id="history" class="tab-content max-w-6xl mx-auto">
            <header class="mb-8">
                <h2 class="text-3xl font-extrabold tracking-tight">Purchase Ledger</h2>
            </header>
            <div class="bg-white rounded-[2rem] border border-slate-200 overflow-hidden card-shadow">
                <table class="w-full text-left">
                    <thead class="bg-slate-50">
                        <tr>
                            <th class="p-6 text-[9px] font-black text-slate-400 uppercase tracking-widest">Date</th>
                            <th class="p-6 text-[9px] font-black text-slate-400 uppercase tracking-widest">Supplier</th>
                            <th class="p-6 text-[9px] font-black text-slate-400 uppercase tracking-widest text-right">Amount</th>
                            <th class="p-6 text-[9px] font-black text-slate-400 uppercase tracking-widest text-center">Delete</th>
                        </tr>
                    </thead>
                    <tbody id="history-table" class="divide-y divide-slate-100"></tbody>
                </table>
            </div>
        </div>

        <!-- ANALYTICS & SMART INSIGHTS -->
        <div id="analytics" class="tab-content max-w-6xl mx-auto space-y-10 pb-20">
            <header class="flex flex-col md:flex-row justify-between items-start md:items-center gap-6">
                <div>
                    <h2 class="text-4xl font-extrabold tracking-tight">Smart Insights</h2>
                    <p class="text-slate-500 font-medium">Predictive purchasing and supplier health.</p>
                </div>
                <div class="flex items-center gap-3 bg-white p-2 rounded-2xl border border-slate-100 shadow-sm">
                    <i class="ph ph-funnel text-slate-400 ml-2"></i>
                    <select id="supplier-selector" onchange="renderSupplierDeepDive(this.value)" class="bg-transparent font-bold outline-none pr-4 text-sm">
                        <option value="all">View All Suppliers</option>
                    </select>
                </div>
            </header>

            <!-- Top Row: General Prediction -->
            <div class="grid grid-cols-1 lg:grid-cols-3 gap-6">
                <div class="lg:col-span-2 bg-white p-8 rounded-[2.5rem] border border-slate-100 card-shadow">
                    <div class="flex items-center justify-between mb-8">
                        <div>
                            <h4 class="text-xl font-black">Purchase Velocity</h4>
                            <p class="text-xs text-slate-400 font-bold uppercase tracking-widest" id="trend-period-label">Last 12 Months</p>
                        </div>
                        <div id="overall-variance-badge" class="px-3 py-1.5 rounded-xl font-black text-[10px] uppercase"></div>
                    </div>
                    <div class="h-64"><canvas id="mainChart"></canvas></div>
                </div>

                <div class="bg-slate-900 p-8 rounded-[2.5rem] text-white flex flex-col justify-between shadow-2xl overflow-hidden relative">
                    <div class="absolute -right-10 -top-10 w-40 h-40 bg-blue-500/10 rounded-full blur-3xl"></div>
                    <div>
                        <div class="flex items-center gap-2 mb-4 text-blue-400">
                            <i class="ph ph-magic-wand-bold text-2xl"></i>
                            <span class="text-[10px] font-black uppercase tracking-widest">Next Month Forecast</span>
                        </div>
                        <h5 class="text-5xl font-black mb-2" id="forecast-val">₹0</h5>
                        <div id="forecast-logic-text" class="text-[10px] text-slate-400 font-bold leading-relaxed uppercase tracking-tighter">Based on your historical average burn rate.</div>
                    </div>
                    <div class="mt-8 pt-8 border-t border-white/10 grid grid-cols-2 gap-4">
                        <div>
                            <p class="text-[9px] font-black text-slate-500 uppercase">Avg Ticket</p>
                            <p class="text-lg font-bold" id="avg-ticket-stat">₹0</p>
                        </div>
                        <div>
                            <p class="text-[9px] font-black text-slate-500 uppercase">Buy Cycle</p>
                            <p class="text-lg font-bold" id="cycle-stat">--</p>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Middle Section: Supplier Deep Dive / Comparison -->
            <div id="supplier-detail-section" class="grid grid-cols-1 lg:grid-cols-2 gap-8">
                <!-- Content injected via JS -->
            </div>

            <!-- Bottom Section: Vendor Table -->
            <div class="bg-white rounded-[2.5rem] p-8 border border-slate-100 card-shadow overflow-hidden">
                <h4 class="text-xs font-black uppercase text-slate-400 tracking-widest mb-6">Supplier Variance & Smart Predictions</h4>
                <div class="overflow-x-auto">
                    <table class="w-full">
                        <thead class="text-left border-b border-slate-50">
                            <tr>
                                <th class="pb-4 text-[10px] font-black text-slate-400 uppercase">Supplier</th>
                                <th class="pb-4 text-[10px] font-black text-slate-400 uppercase">Current Variance</th>
                                <th class="pb-4 text-[10px] font-black text-slate-400 uppercase">Purchase Frequency</th>
                                <th class="pb-4 text-[10px] font-black text-slate-400 uppercase text-right">Predicted Next Buy</th>
                            </tr>
                        </thead>
                        <tbody id="supplier-prediction-table" class="divide-y divide-slate-50"></tbody>
                    </table>
                </div>
            </div>
        </div>
    </main>

    <script>
        let purchases = JSON.parse(localStorage.getItem('oms_purchases_v2') || '[]');
        let charts = {};

        function saveData() {
            localStorage.setItem('oms_purchases_v2', JSON.stringify(purchases));
            refreshUI();
        }

        function refreshUI() {
            renderDashboard();
            renderHistory();
            updateSupplierSelector();
            if (document.getElementById('analytics').classList.contains('active')) {
                const currentVendor = document.getElementById('supplier-selector').value;
                renderAnalytics(currentVendor);
            }
        }

        function switchTab(id) {
            document.querySelectorAll('.tab-content').forEach(el => el.classList.remove('active'));
            document.querySelectorAll('.nav-item').forEach(el => el.classList.remove('active'));
            document.getElementById(id).classList.add('active');
            document.getElementById('btn-' + id).classList.add('active');
            if (id === 'analytics') {
                setTimeout(() => renderAnalytics('all'), 100);
            }
        }

        function handlePurchaseSubmit() {
            const entry = {
                id: crypto.randomUUID(),
                supplier: document.getElementById('p-supplier').value.trim(),
                category: document.getElementById('p-category').value,
                date: document.getElementById('p-date').value,
                total: parseFloat(document.getElementById('p-total').value),
                paid: parseFloat(document.getElementById('p-paid').value) || 0,
                mode: document.getElementById('p-mode').value,
                ts: new Date(document.getElementById('p-date').value).getTime()
            };
            if(!entry.supplier) return;
            purchases.unshift(entry);
            saveData();
            showToast("Purchase Record Secured");
            document.getElementById('purchase-form').reset();
            document.getElementById('p-date').valueAsDate = new Date();
        }

        function deleteRecord(id) {
            purchases = purchases.filter(p => p.id !== id);
            saveData();
        }

        function renderDashboard() {
            const total = purchases.reduce((a, b) => a + b.total, 0);
            const due = purchases.reduce((a, b) => a + (b.total - b.paid), 0);
            
            document.getElementById('dash-total-buy').innerText = `₹${total.toLocaleString()}`;
            document.getElementById('dash-total-dues').innerText = `₹${due.toLocaleString()}`;

            // Growth Index (Current Month vs Prev)
            const growth = calculateGrowthIndex();
            const growthEl = document.getElementById('dash-growth-index');
            growthEl.innerText = growth.text;
            growthEl.className = `text-3xl font-black ${growth.val > 0 ? 'text-red-600' : growth.val < 0 ? 'text-green-600' : 'text-blue-700'}`;

            // Requirements List
            const dailyAvg = total / Math.max(1, (Date.now() - Math.min(...purchases.map(p => p.ts), Date.now())) / 86400000);
            const reqs = [
                { title: 'Weekly Buffer', val: dailyAvg * 7, color: 'blue', icon: 'ph-calendar' },
                { title: 'Monthly Reserve', val: dailyAvg * 30, color: 'indigo', icon: 'ph-briefcase' }
            ];
            document.getElementById('requirement-list').innerHTML = reqs.map(r => `
                <div class="bg-white p-5 rounded-2xl border border-slate-100 flex items-center justify-between shadow-sm">
                    <div class="flex items-center gap-3">
                        <div class="w-10 h-10 rounded-xl bg-${r.color}-50 text-${r.color}-600 flex items-center justify-center"><i class="ph ${r.icon} text-xl"></i></div>
                        <div><p class="text-[9px] font-black text-slate-400 uppercase">${r.title}</p><h5 class="font-black">₹${Math.round(r.val).toLocaleString()}</h5></div>
                    </div>
                </div>
            `).join('');

            document.getElementById('recent-list').innerHTML = purchases.slice(0, 3).map(p => `
                <div class="bg-white p-4 rounded-2xl flex justify-between items-center border border-slate-50">
                    <div class="flex items-center gap-3">
                        <div class="w-8 h-8 bg-slate-100 rounded-full flex items-center justify-center text-[10px] font-black">${p.supplier[0]}</div>
                        <div><p class="font-bold text-xs">${p.supplier}</p><p class="text-[9px] text-slate-400 uppercase font-bold">${p.category}</p></div>
                    </div>
                    <p class="font-black text-sm">₹${p.total.toLocaleString()}</p>
                </div>
            `).join('') || '<p class="text-xs text-slate-400 italic">No recent logs.</p>';
        }

        function calculateGrowthIndex() {
            if (purchases.length < 2) return { text: '--', val: 0 };
            const m = (date) => date.substring(0, 7);
            const nowM = m(new Date().toISOString());
            const lastMDate = new Date(); lastMDate.setMonth(lastMDate.getMonth() - 1);
            const lastM = m(lastMDate.toISOString());

            const curTotal = purchases.filter(p => m(p.date) === nowM).reduce((a,b) => a+b.total, 0);
            const prevTotal = purchases.filter(p => m(p.date) === lastM).reduce((a,b) => a+b.total, 0);

            if (prevTotal === 0) return { text: 'New', val: 0 };
            const diff = ((curTotal - prevTotal) / prevTotal) * 100;
            return { text: `${diff > 0 ? '+' : ''}${Math.round(diff)}%`, val: diff };
        }

        function renderHistory() {
            document.getElementById('history-table').innerHTML = purchases.map(p => `
                <tr class="hover:bg-slate-50">
                    <td class="p-6 font-mono text-[11px] text-slate-400">${p.date}</td>
                    <td class="p-6 font-bold text-sm">${p.supplier}</td>
                    <td class="p-6 text-right font-black">₹${p.total.toLocaleString()}</td>
                    <td class="p-6 text-center">
                        <button onclick="deleteRecord('${p.id}')" class="text-slate-300 hover:text-red-500"><i class="ph ph-trash-simple text-lg"></i></button>
                    </td>
                </tr>
            `).join('');
        }

        function updateSupplierSelector() {
            const list = [...new Set(purchases.map(p => p.supplier))];
            const selector = document.getElementById('supplier-selector');
            const current = selector.value;
            selector.innerHTML = `<option value="all">View All Suppliers</option>` + list.map(s => `<option value="${s}">${s}</option>`).join('');
            selector.value = current;
            
            const datalist = document.getElementById('supplier-list');
            datalist.innerHTML = list.map(v => `<option value="${v}">`).join('');
        }

        function renderAnalytics(filterVendor = 'all') {
            if (!purchases.length) return;

            const filtered = filterVendor === 'all' ? purchases : purchases.filter(p => p.supplier === filterVendor);
            
            // Monthly Trend Aggregation
            const months = {};
            filtered.forEach(p => {
                const m = p.date.substring(0, 7);
                months[m] = (months[m] || 0) + p.total;
            });
            const labels = Object.keys(months).sort().slice(-12);
            const data = labels.map(l => months[l]);

            // Chart Rendering
            if (charts.main) charts.main.destroy();
            charts.main = new Chart(document.getElementById('mainChart'), {
                type: 'line',
                data: {
                    labels,
                    datasets: [{
                        label: 'Purchase Vol',
                        data: data,
                        borderColor: '#2563eb',
                        backgroundColor: 'rgba(37,99,235,0.05)',
                        fill: true,
                        tension: 0.4,
                        borderWidth: 4,
                        pointRadius: 2
                    }]
                },
                options: { maintainAspectRatio: false, plugins: { legend: { display: false } }, scales: { x: { grid: { display: false } }, y: { grid: { color: '#f1f5f9' } } } }
            });

            // Overall Variance Badge
            if(data.length >= 2) {
                const diff = ((data[data.length-1] - data[data.length-2]) / (data[data.length-2] || 1)) * 100;
                const badge = document.getElementById('overall-variance-badge');
                badge.innerText = `${diff > 0 ? '↑' : '↓'} ${Math.abs(Math.round(diff))}% Variance`;
                badge.className = `px-3 py-1.5 rounded-xl font-black text-[10px] uppercase ${diff > 0 ? 'bg-red-50 text-red-600' : 'bg-green-50 text-green-600'}`;
            }

            // Global Predictions
            const totalVal = filtered.reduce((a,b) => a+b.total, 0);
            const avgTicket = totalVal / filtered.length;
            const earliest = Math.min(...filtered.map(p => p.ts));
            const daysRange = Math.max(1, (Date.now() - earliest) / 86400000);
            const monthlyForecast = (totalVal / daysRange) * 30;

            document.getElementById('forecast-val').innerText = `₹${Math.round(monthlyForecast).toLocaleString()}`;
            document.getElementById('avg-ticket-stat').innerText = `₹${Math.round(avgTicket).toLocaleString()}`;
            document.getElementById('cycle-stat').innerText = `${Math.round(daysRange / (filtered.length || 1))} Days`;

            // Supplier Table Predictions
            renderSupplierTable();
            renderSupplierDeepDive(filterVendor);
        }

        function renderSupplierTable() {
            const suppliers = {};
            purchases.forEach(p => {
                if(!suppliers[p.supplier]) suppliers[p.supplier] = [];
                suppliers[p.supplier].push(p);
            });

            const rows = Object.entries(suppliers).map(([name, logs]) => {
                logs.sort((a,b) => b.ts - a.ts);
                const last = logs[0].total;
                const prev = logs[1] ? logs[1].total : last;
                const varPct = ((last - prev) / (prev || 1)) * 100;
                
                const earliest = Math.min(...logs.map(l => l.ts));
                const cycle = Math.round((Date.now() - earliest) / (86400000 * logs.length));
                const nextPrediction = logs.reduce((a,b) => a+b.total, 0) / logs.length;

                return { name, varPct, cycle, nextPrediction };
            }).sort((a,b) => b.nextPrediction - a.nextPrediction);

            document.getElementById('supplier-prediction-table').innerHTML = rows.map(r => `
                <tr>
                    <td class="py-5 font-bold text-sm">${r.name}</td>
                    <td class="py-5">
                        <span class="text-[10px] font-black uppercase px-2 py-1 rounded-lg ${r.varPct > 0 ? 'bg-red-50 text-red-500' : 'bg-green-50 text-green-500'}">
                            ${r.varPct > 0 ? '+' : ''}${Math.round(r.varPct)}% ${r.varPct > 0 ? '↑' : '↓'}
                        </span>
                    </td>
                    <td class="py-5 text-xs text-slate-500 font-bold">Every ${r.cycle} Days</td>
                    <td class="py-5 text-right font-black text-blue-600">₹${Math.round(r.nextPrediction).toLocaleString()}</td>
                </tr>
            `).join('');
        }

        function renderSupplierDeepDive(vendor) {
            const container = document.getElementById('supplier-detail-section');
            if (vendor === 'all') {
                container.innerHTML = `
                    <div class="bg-white p-8 rounded-[2.5rem] card-shadow border border-slate-100 flex flex-col items-center justify-center text-center space-y-4">
                        <div class="w-16 h-16 bg-blue-50 text-blue-600 rounded-full flex items-center justify-center"><i class="ph ph-chart-pie-slice text-3xl"></i></div>
                        <div><h4 class="font-black text-lg">Category Distribution</h4><p class="text-xs text-slate-400">Where is your money going?</p></div>
                        <div class="w-full h-48"><canvas id="catChart"></canvas></div>
                    </div>
                    <div class="bg-white p-8 rounded-[2.5rem] card-shadow border border-slate-100 flex flex-col items-center justify-center text-center space-y-4">
                        <div class="w-16 h-16 bg-purple-50 text-purple-600 rounded-full flex items-center justify-center"><i class="ph ph-users-three text-3xl"></i></div>
                        <div><h4 class="font-black text-lg">Vendor Concentration</h4><p class="text-xs text-slate-400">Main source of supplies</p></div>
                        <div class="w-full h-48"><canvas id="venChart"></canvas></div>
                    </div>
                `;
                renderGlobalCharts();
                return;
            }

            // Vendor Specific View
            const logs = purchases.filter(p => p.supplier === vendor);
            const cats = {}; logs.forEach(l => cats[l.category] = (cats[l.category] || 0) + l.total);
            const topCat = Object.entries(cats).sort((a,b) => b[1]-a[1])[0][0];
            const avg = logs.reduce((a,b) => a+b.total, 0) / logs.length;

            container.innerHTML = `
                <div class="bg-blue-600 p-8 rounded-[2.5rem] text-white card-shadow relative overflow-hidden">
                    <i class="ph ph-identification-card absolute -right-4 -bottom-4 text-9xl opacity-10"></i>
                    <h4 class="text-2xl font-black mb-1">${vendor}</h4>
                    <p class="text-[10px] font-black uppercase tracking-widest opacity-70 mb-6">Vendor Strategic Profile</p>
                    <div class="space-y-4">
                        <div class="bg-white/10 p-4 rounded-2xl">
                            <p class="text-[9px] font-black uppercase opacity-60">Primary Category</p>
                            <p class="text-lg font-bold">${topCat}</p>
                        </div>
                        <div class="grid grid-cols-2 gap-4">
                            <div class="bg-white/10 p-4 rounded-2xl">
                                <p class="text-[9px] font-black uppercase opacity-60">Total Orders</p>
                                <p class="text-lg font-bold">${logs.length}</p>
                            </div>
                            <div class="bg-white/10 p-4 rounded-2xl">
                                <p class="text-[9px] font-black uppercase opacity-60">Loyalty Score</p>
                                <p class="text-lg font-bold">${logs.length > 5 ? 'High' : 'Standard'}</p>
                            </div>
                        </div>
                    </div>
                </div>
                <div class="bg-white p-8 rounded-[2.5rem] card-shadow border border-slate-100">
                    <h4 class="text-lg font-black mb-4">Smart Prediction</h4>
                    <div class="p-6 bg-slate-50 rounded-2xl border border-dashed border-slate-200 text-center space-y-3">
                        <p class="text-xs font-medium text-slate-500">Based on historical patterns, your next purchase from <b>${vendor}</b> is expected to be:</p>
                        <div class="text-3xl font-black text-blue-600">₹${Math.round(avg).toLocaleString()}</div>
                        <p class="text-[9px] font-black uppercase text-slate-400">Suggested Budget Allocation</p>
                    </div>
                    <div class="mt-6">
                         <h5 class="text-[10px] font-black uppercase text-slate-400 mb-3">Health Insight</h5>
                         <div class="flex items-center gap-3">
                            <div class="w-2 h-2 rounded-full bg-green-500 animate-pulse"></div>
                            <p class="text-xs font-bold text-slate-700">Vendor relations stable. Last variance within ±5%.</p>
                         </div>
                    </div>
                </div>
            `;
        }

        function renderGlobalCharts() {
            const cMap = {}; purchases.forEach(p => cMap[p.category] = (cMap[p.category] || 0) + p.total);
            if(charts.cat) charts.cat.destroy();
            charts.cat = new Chart(document.getElementById('catChart'), {
                type: 'doughnut',
                data: { labels: Object.keys(cMap), datasets: [{ data: Object.values(cMap), backgroundColor: ['#1e293b', '#3b82f6', '#8b5cf6', '#ec4899'] }] },
                options: { maintainAspectRatio: false, cutout: '70%', plugins: { legend: { display: false } } }
            });

            const vMap = {}; purchases.forEach(p => vMap[p.supplier] = (vMap[p.supplier] || 0) + p.total);
            const vTop = Object.entries(vMap).sort((a,b) => b[1]-a[1]).slice(0, 5);
            if(charts.ven) charts.ven.destroy();
            charts.ven = new Chart(document.getElementById('venChart'), {
                type: 'bar',
                data: { labels: vTop.map(v => v[0]), datasets: [{ data: vTop.map(v => v[1]), backgroundColor: '#3b82f6', borderRadius: 8 }] },
                options: { maintainAspectRatio: false, plugins: { legend: { display: false } }, scales: { y: { display: false }, x: { grid: { display: false } } } }
            });
        }

        function showToast(m) {
            const t = document.getElementById('toast');
            document.getElementById('toast-msg').innerText = m;
            t.classList.remove('translate-x-[200%]');
            setTimeout(() => t.classList.add('translate-x-[200%]'), 3000);
        }

        document.getElementById('p-date').valueAsDate = new Date();
        refreshUI();
    </script>
</body>
</html>
