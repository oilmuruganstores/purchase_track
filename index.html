<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<title>Oil Murugan Stores | Advanced Purchase Analytics</title>

<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf-autotable/3.5.29/jspdf.plugin.autotable.min.js"></script>

<style>
body{
 margin:0;
 font-family:Poppins,Segoe UI,sans-serif;
 background:
  linear-gradient(135deg,rgba(253,230,138,.9),rgba(253,186,116,.9)),
  url("data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' width='900' height='400'%3E%3Ctext x='50%25' y='50%25' text-anchor='middle' dominant-baseline='middle' fill='rgba(0,0,0,0.05)' font-size='90' font-family='Arial Black'%3EOIL MURUGAN STORES%3C/text%3E%3C/svg%3E");
 background-repeat:repeat;
}
.app{max-width:1500px;margin:auto;padding:24px}
h1{margin:0;color:#713f12}
.tabs{display:flex;gap:12px;margin:20px 0}
.tab{padding:12px 22px;border-radius:999px;background:#fde68a;font-weight:800;cursor:pointer}
.tab.active{background:#ca8a04;color:#fff}
.panel{display:none}
.panel.active{display:block}
.dashboard{display:grid;grid-template-columns:repeat(auto-fit,minmax(220px,1fr));gap:16px}
.card{background:#fff;border-radius:20px;padding:20px;box-shadow:0 12px 30px rgba(0,0,0,.18)}
.chart-box{background:#fff;border-radius:20px;padding:20px;margin:20px 0}
.up{color:#15803d;font-weight:800}
.down{color:#b91c1c;font-weight:800}
</style>
</head>

<body>
<div class="app">
<h1>OIL MURUGAN STORES</h1>

<div class="tabs">
 <div class="tab active" onclick="openTab('analytics')">Analytics</div>
</div>

<div id="analytics" class="panel active">

<!-- KPI -->
<div class="dashboard">
 <div class="card"><p>Avg Purchase / Day</p><h2 id="avgDay">Rs. 0</h2></div>
 <div class="card"><p>Next Week Forecast</p><h2 id="weekForecast">Rs. 0</h2></div>
 <div class="card"><p>Next Month Forecast</p><h2 id="monthForecast">Rs. 0</h2></div>
</div>

<!-- WEEKDAY -->
<div class="chart-box">
 <h3>Weekday Trend (Mon â€“ Sun)</h3>
 <canvas id="weekdayChart"></canvas>
</div>

<!-- WEEKLY -->
<div class="chart-box">
 <h3>Week-wise Purchase Trend</h3>
 <canvas id="weeklyChart"></canvas>
</div>

<!-- MONTHLY -->
<div class="chart-box">
 <h3>Month-wise Purchase Trend</h3>
 <canvas id="monthlyChart"></canvas>
</div>

<!-- SUPPLIER FORECAST -->
<div class="chart-box">
 <h3>Supplier-wise Next Month Forecast</h3>
 <table id="supplierForecast" border="1" width="100%"></table>
</div>

</div>
</div>

<script>
let data = JSON.parse(localStorage.getItem("oil_murugan_data")) || [];

function paid(e){return (e.cash||0)+(e.upi||0)+(e.net||0)}

function openTab(id){
 document.querySelectorAll(".panel").forEach(p=>p.classList.remove("active"));
 document.querySelectorAll(".tab").forEach(t=>t.classList.remove("active"));
 document.getElementById(id).classList.add("active");
 event.target.classList.add("active");
}

function analytics(){
 if(!data.length) return;

 /* WEEKDAY */
 const days=["Monday","Tuesday","Wednesday","Thursday","Friday","Saturday","Sunday"];
 let sum={},count={};
 days.forEach(d=>{sum[d]=0;count[d]=0});
 data.forEach(e=>{
  let d=days[(new Date(e.date).getDay()+6)%7];
  sum[d]+=e.bill;count[d]++;
 });
 let avg=days.map(d=>count[d]?Math.round(sum[d]/count[d]):0);

 /* AVG DAY KPI */
 avgDay.textContent="Rs. "+Math.round(avg.reduce((a,b)=>a+b,0)/7);

 /* WEEKDAY CHART */
 new Chart(document.getElementById("weekdayChart"),{
  type:"line",
  data:{labels:days,datasets:[{label:"Avg Purchase",data:avg,borderColor:"#15803d",tension:.4}]}
 });

 /* WEEKLY */
 let weekMap={};
 data.forEach(e=>{
  let d=new Date(e.date);
  let week=d.getFullYear()+"-W"+Math.ceil(d.getDate()/7);
  weekMap[week]=(weekMap[week]||0)+e.bill;
 });
 let weeks=Object.keys(weekMap);
 let weekVals=weeks.map(w=>weekMap[w]);

 new Chart(document.getElementById("weeklyChart"),{
  type:"bar",
  data:{labels:weeks,datasets:[{label:"Weekly Purchase",data:weekVals,backgroundColor:"#ca8a04"}]}
 });

 /* MONTHLY */
 let monthMap={};
 data.forEach(e=>{
  let m=e.date.slice(0,7);
  monthMap[m]=(monthMap[m]||0)+e.bill;
 });
 let months=Object.keys(monthMap);
 let monthVals=months.map(m=>monthMap[m]);

 new Chart(document.getElementById("monthlyChart"),{
  type:"bar",
  data:{labels:months,datasets:[{label:"Monthly Purchase",data:monthVals,backgroundColor:"#92400e"}]}
 });

 /* FORECAST */
 let last3=monthVals.slice(-3);
 let nextMonth=Math.round(last3.reduce((a,b)=>a+b,0)/(last3.length||1));
 monthForecast.textContent="Rs. "+nextMonth;
 weekForecast.textContent="Rs. "+Math.round(nextMonth/4);

 /* SUPPLIER FORECAST */
 let supMap={};
 data.forEach(e=>{
  supMap[e.supplier]=(supMap[e.supplier]||[]).concat(e.bill);
 });
 let tbl="<tr><th>Supplier</th><th>Expected Next Month (Rs.)</th></tr>";
 Object.keys(supMap).forEach(s=>{
  let bills=supMap[s];
  let est=Math.round(bills.slice(-3).reduce((a,b)=>a+b,0)/(bills.slice(-3).length||1));
  tbl+=`<tr><td>${s}</td><td>Rs. ${est}</td></tr>`;
 });
 supplierForecast.innerHTML=tbl;
}

analytics();
</script>

</body>
</html>
