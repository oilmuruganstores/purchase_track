<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Oil Murugan Stores | Cloud Manager</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&display=swap" rel="stylesheet">
    <script src="https://unpkg.com/@phosphor-icons/web"></script>
    
    <!-- Firebase SDKs -->
    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.1.0/firebase-app.js";
        import { getAuth, signInAnonymously, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/11.1.0/firebase-auth.js";
        import { getFirestore, collection, addDoc, updateDoc, deleteDoc, doc, onSnapshot, query, setDoc } from "https://www.gstatic.com/firebasejs/11.1.0/firebase-firestore.js";

        const firebaseConfig = JSON.parse(__firebase_config);
        const app = initializeApp(firebaseConfig);
        const auth = getAuth(app);
        const db = getFirestore(app);
        const appId = typeof __app_id !== 'undefined' ? __app_id : 'oil-murugan-stores';

        window.db = db;
        window.auth = auth;
        window.appId = appId;
        window.firestoreUtils = { collection, addDoc, updateDoc, deleteDoc, doc, onSnapshot, query, setDoc };
    </script>

    <script>
        tailwind.config = {
            theme: {
                extend: {
                    fontFamily: { sans: ['Inter', 'sans-serif'] },
                    colors: {
                        ios: {
                            bg: '#F2F2F7', card: '#FFFFFF', blue: '#007AFF',
                            green: '#34C759', red: '#FF3B30', gray: '#8E8E93', separator: '#C6C6C8'
                        }
                    }
                }
            }
        }
    </script>
    <style>
        body { background-color: #F2F2F7; }
        .tab-content { display: none; }
        .tab-content.active { display: block; animation: fadeIn 0.2s ease-out; }
        @keyframes fadeIn { from { opacity: 0; transform: translateY(4px); } to { opacity: 1; transform: translateY(0); } }
        .scroller::-webkit-scrollbar { width: 6px; height: 6px; }
        .scroller::-webkit-scrollbar-thumb { background: #C6C6C8; border-radius: 4px; }
        .modal-backdrop { background: rgba(0,0,0,0.4); backdrop-filter: blur(4px); }
    </style>
</head>
<body class="text-gray-800 antialiased h-screen flex flex-col md:flex-row overflow-hidden">

    <!-- Sidebar -->
    <aside class="bg-white border-r border-ios-separator w-full md:w-64 flex-shrink-0 flex flex-col justify-between z-20">
        <div>
            <div class="p-6 border-b border-ios-separator/50">
                <h1 class="text-xl font-bold tracking-tight text-gray-900">OIL MURUGAN <br><span class="text-ios-blue font-medium text-sm">STORES</span></h1>
                <div id="sync-status" class="text-[10px] mt-2 flex items-center gap-1 text-gray-400">
                    <span class="w-2 h-2 rounded-full bg-yellow-400 animate-pulse"></span> Connecting...
                </div>
            </div>
            <nav class="p-4 space-y-1">
                <button onclick="switchTab('today')" id="nav-today" class="nav-btn w-full flex items-center gap-3 px-4 py-3 text-sm font-medium rounded-xl text-white bg-ios-blue">
                    <i class="ph ph-plus-circle text-lg"></i> Today's Entry
                </button>
                <button onclick="switchTab('history')" id="nav-history" class="nav-btn w-full flex items-center gap-3 px-4 py-3 text-sm font-medium rounded-xl text-gray-600 hover:bg-gray-100">
                    <i class="ph ph-clock-counter-clockwise text-lg"></i> History
                </button>
                <button onclick="switchTab('supplier')" id="nav-supplier" class="nav-btn w-full flex items-center gap-3 px-4 py-3 text-sm font-medium rounded-xl text-gray-600 hover:bg-gray-100">
                    <i class="ph ph-address-book text-lg"></i> Supplier View
                </button>
                <button onclick="switchTab('forecast')" id="nav-forecast" class="nav-btn w-full flex items-center gap-3 px-4 py-3 text-sm font-medium rounded-xl text-gray-600 hover:bg-gray-100">
                    <i class="ph ph-lightbulb text-lg"></i> Forecast
                </button>
            </nav>
        </div>
    </aside>

    <!-- Main Content -->
    <main class="flex-1 overflow-y-auto scroller p-4 md:p-8 relative">
        <div id="toast" class="fixed top-4 right-4 bg-gray-900 text-white px-6 py-3 rounded-xl shadow-lg transform translate-x-[150%] transition-transform duration-300 z-50 flex items-center gap-2">
            <i class="ph ph-check-circle text-green-400 text-xl"></i>
            <span id="toast-msg">Success</span>
        </div>

        <!-- TAB: TODAY -->
        <div id="today" class="tab-content active max-w-5xl mx-auto">
            <header class="mb-8">
                <h2 class="text-3xl font-bold text-gray-900">Today's Purchase</h2>
                <p class="text-gray-500 text-sm mt-1" id="current-date-display"></p>
            </header>

            <div class="grid grid-cols-1 md:grid-cols-3 gap-6 mb-8">
                <div class="bg-white p-6 rounded-2xl shadow-sm border border-gray-100">
                    <p class="text-xs font-semibold text-gray-400 uppercase tracking-wider">Today's Total</p>
                    <h3 class="text-2xl font-bold text-gray-900 mt-2" id="dash-today-total">₹0</h3>
                </div>
                <div class="bg-white p-6 rounded-2xl shadow-sm border border-gray-100">
                    <p class="text-xs font-semibold text-gray-400 uppercase tracking-wider">Today's Paid</p>
                    <h3 class="text-2xl font-bold text-ios-green mt-2" id="dash-today-paid">₹0</h3>
                </div>
                <div class="bg-white p-6 rounded-2xl shadow-sm border border-gray-100">
                    <p class="text-xs font-semibold text-gray-400 uppercase tracking-wider">Today's Balance</p>
                    <h3 class="text-2xl font-bold text-ios-red mt-2" id="dash-today-pending">₹0</h3>
                </div>
            </div>

            <div class="bg-white rounded-2xl shadow-sm border border-gray-100 p-6">
                <form id="entry-form" class="space-y-6">
                    <input type="hidden" id="edit-id" value="">
                    <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
                        <div>
                            <label class="block text-sm font-medium text-gray-700 mb-2">Supplier Name</label>
                            <input type="text" id="inp-supplier" list="supplier-list" class="w-full px-4 py-3 rounded-xl border border-gray-200 focus:ring-2 focus:ring-ios-blue/20 outline-none transition-all bg-gray-50 focus:bg-white" required>
                            <datalist id="supplier-list"></datalist>
                        </div>
                        <div>
                            <label class="block text-sm font-medium text-gray-700 mb-2">Bill Amount (₹)</label>
                            <input type="number" id="inp-bill" class="w-full px-4 py-3 rounded-xl border border-gray-200 font-mono text-lg outline-none focus:ring-2 focus:ring-ios-blue/20 bg-gray-50" required step="0.01">
                        </div>
                    </div>
                    <div class="bg-gray-50 p-6 rounded-xl border border-gray-100">
                        <label class="block text-sm font-semibold text-gray-700 mb-4">Payment Breakdown</label>
                        <div class="grid grid-cols-1 md:grid-cols-3 gap-4">
                            <div><label class="text-xs text-gray-500 mb-1 block">Cash</label><input type="number" id="inp-cash" class="w-full px-3 py-2 rounded-lg border border-gray-200" placeholder="0"></div>
                            <div><label class="text-xs text-gray-500 mb-1 block">UPI</label><input type="number" id="inp-upi" class="w-full px-3 py-2 rounded-lg border border-gray-200" placeholder="0"></div>
                            <div><label class="text-xs text-gray-500 mb-1 block">Net Banking</label><input type="number" id="inp-net" class="w-full px-3 py-2 rounded-lg border border-gray-200" placeholder="0"></div>
                        </div>
                        <div class="mt-4 flex justify-between items-center text-sm border-t pt-4">
                            <span class="text-gray-500">Calculated Balance:</span>
                            <span class="font-bold text-ios-red text-lg" id="calc-pending">₹0</span>
                        </div>
                    </div>
                    <div class="flex gap-3">
                        <button type="submit" id="submit-btn" class="flex-1 bg-gray-900 hover:bg-black text-white font-medium py-4 rounded-xl shadow-lg transition-all flex justify-center items-center gap-2">
                            <i class="ph ph-cloud-arrow-up"></i> <span id="btn-text">Save to Cloud</span>
                        </button>
                        <button type="button" id="cancel-edit" onclick="resetForm()" class="hidden px-6 py-4 bg-gray-200 text-gray-700 rounded-xl hover:bg-gray-300 font-medium">Cancel Edit</button>
                    </div>
                </form>
            </div>
        </div>

        <!-- TAB: HISTORY -->
        <div id="history" class="tab-content max-w-6xl mx-auto">
            <header class="mb-8 flex justify-between items-center">
                <h2 class="text-3xl font-bold text-gray-900">History & Totals</h2>
                <div class="flex gap-4 text-xs font-semibold uppercase">
                    <div class="bg-blue-50 p-3 rounded-xl border border-blue-100 text-center">
                        <span class="text-blue-500 block">Filtered Total</span>
                        <span class="text-gray-900 text-base" id="hist-total-sum">₹0</span>
                    </div>
                    <div class="bg-red-50 p-3 rounded-xl border border-red-100 text-center">
                        <span class="text-red-500 block">Pending Balance</span>
                        <span class="text-gray-900 text-base" id="hist-pending-sum">₹0</span>
                    </div>
                </div>
            </header>
            
            <div class="bg-white rounded-2xl shadow-sm border border-gray-100 overflow-hidden">
                <div class="p-4 border-b border-gray-100 bg-gray-50 flex flex-wrap gap-4 items-center">
                    <div class="flex-1 min-w-[200px]">
                        <input type="text" id="hist-search" oninput="renderHistory()" placeholder="Search Supplier..." class="w-full px-4 py-2 rounded-lg border border-gray-200 text-sm outline-none">
                    </div>
                    <input type="date" id="hist-date-start" onchange="renderHistory()" class="px-3 py-2 rounded-lg border border-gray-200 text-sm outline-none">
                    <input type="date" id="hist-date-end" onchange="renderHistory()" class="px-3 py-2 rounded-lg border border-gray-200 text-sm outline-none">
                </div>
                <div class="overflow-x-auto">
                    <table class="w-full text-left">
                        <thead>
                            <tr class="bg-gray-50 text-gray-500 text-xs uppercase border-b border-gray-200">
                                <th class="p-4">Date</th>
                                <th class="p-4">Supplier</th>
                                <th class="p-4 text-right">Bill</th>
                                <th class="p-4 text-right">Paid</th>
                                <th class="p-4 text-right">Pending</th>
                                <th class="p-4 text-center">Actions</th>
                            </tr>
                        </thead>
                        <tbody id="history-table-body" class="text-sm text-gray-700"></tbody>
                    </table>
                </div>
            </div>
        </div>

        <!-- TAB: SUPPLIER VIEW -->
        <div id="supplier" class="tab-content max-w-5xl mx-auto">
             <header class="mb-8"><h2 class="text-3xl font-bold text-gray-900">Supplier Ledger</h2></header>
             <div class="grid grid-cols-1 md:grid-cols-3 gap-6">
                 <div class="bg-white p-6 rounded-2xl border border-gray-100 shadow-sm">
                     <label class="text-xs font-bold text-gray-400 uppercase mb-2 block">Select Provider</label>
                     <select id="ledger-select" class="w-full p-3 rounded-xl border border-gray-200 outline-none bg-gray-50" onchange="renderSupplierLedger()">
                         <option value="">Select Supplier</option>
                     </select>
                     <div id="ledger-summary" class="mt-6 hidden space-y-4">
                         <div class="flex justify-between text-sm"><span class="text-gray-500">Gross Purchase</span> <span class="font-bold" id="led-total-bill">₹0</span></div>
                         <div class="flex justify-between text-sm text-green-600 font-medium"><span>Total Paid</span> <span id="led-total-paid">₹0</span></div>
                         <div class="p-4 bg-red-50 rounded-xl flex justify-between items-center"><span class="text-red-600 text-xs font-bold uppercase">Balance Due</span> <span class="font-bold text-red-700 text-lg" id="led-balance">₹0</span></div>
                     </div>
                 </div>
                 <div class="md:col-span-2 bg-white rounded-2xl border border-gray-100 shadow-sm overflow-hidden min-h-[400px]">
                     <table class="w-full text-left text-sm">
                         <thead class="bg-gray-50"><tr><th class="p-4">Date</th><th class="p-4 text-right">Bill</th><th class="p-4 text-right">Paid</th><th class="p-4 text-right font-bold">Bal</th></tr></thead>
                         <tbody id="ledger-body"></tbody>
                     </table>
                     <div id="ledger-empty" class="p-12 text-center text-gray-400">Select a supplier to view history.</div>
                 </div>
             </div>
        </div>

        <!-- TAB: FORECAST -->
        <div id="forecast" class="tab-content max-w-5xl mx-auto">
            <header class="mb-8"><h2 class="text-3xl font-bold text-gray-900">Predicted Upcoming Spend</h2></header>
            <div class="bg-white p-6 rounded-2xl border border-gray-100 mb-8 flex flex-wrap gap-4 items-center">
                <div class="flex-1">
                    <label class="text-xs font-bold text-gray-400 uppercase mb-2 block">Predict for Supplier</label>
                    <select id="fc-supplier-select" onchange="renderForecast()" class="w-full md:w-64 p-3 rounded-xl border border-gray-200 outline-none bg-gray-50">
                        <option value="all">All Suppliers (Grand Total)</option>
                    </select>
                </div>
            </div>
            <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
                <div class="bg-gradient-to-br from-gray-900 to-blue-900 p-8 rounded-3xl text-white shadow-xl">
                    <p class="text-blue-300 text-xs font-bold uppercase tracking-widest mb-2">Predicted Next 7 Days</p>
                    <h3 class="text-5xl font-bold" id="fc-next-week">₹0</h3>
                    <div class="mt-8 pt-6 border-t border-white/10 flex justify-between items-center">
                        <span class="text-blue-200 text-sm">Next 30 Days Forecast:</span>
                        <span class="text-white font-bold text-xl" id="fc-next-month">₹0</span>
                    </div>
                </div>
                <div class="bg-white p-8 rounded-3xl border border-gray-100">
                    <h3 class="text-lg font-bold mb-4 flex items-center gap-2">
                        <i class="ph ph-sparkle text-ios-blue"></i> Smart Insights
                    </h3>
                    <ul id="insights-list" class="space-y-4 text-sm text-gray-600">
                        <li class="flex gap-3"><i class="ph ph-info text-blue-500 mt-1"></i> Add more data to improve prediction accuracy.</li>
                    </ul>
                </div>
            </div>
        </div>
    </main>

    <!-- Modals -->
    <div id="delete-modal" class="fixed inset-0 modal-backdrop hidden z-[100] flex items-center justify-center p-4">
        <div class="bg-white w-full max-w-xs p-8 rounded-3xl shadow-2xl text-center">
            <div class="w-16 h-16 bg-red-50 text-red-500 rounded-full flex items-center justify-center mx-auto mb-4 text-3xl"><i class="ph ph-trash"></i></div>
            <h4 class="text-xl font-bold text-gray-900">Delete Entry?</h4>
            <p class="text-sm text-gray-500 mt-2">This will permanently remove the record from the cloud.</p>
            <div class="flex gap-3 mt-8">
                <button onclick="closeDeleteModal()" class="flex-1 py-3 bg-gray-100 text-gray-600 rounded-xl font-medium">Cancel</button>
                <button id="confirm-delete-btn" class="flex-1 py-3 bg-red-500 text-white rounded-xl font-medium">Delete</button>
            </div>
        </div>
    </div>

    <script type="module">
        let appData = [];
        let currentUser = null;
        let deleteId = null;

        async function startApp() {
            const { auth, db, appId, firestoreUtils } = window;
            const statusEl = document.getElementById('sync-status');

            onAuthStateChanged(auth, (user) => {
                if (!user) {
                    signInAnonymously(auth);
                    return;
                }
                currentUser = user;
                statusEl.innerHTML = `<span class="w-2 h-2 rounded-full bg-green-500"></span> Cloud Active`;
                
                const q = firestoreUtils.query(firestoreUtils.collection(db, 'artifacts', appId, 'users', user.uid, 'purchases'));
                firestoreUtils.onSnapshot(q, (snapshot) => {
                    appData = snapshot.docs.map(doc => ({ id: doc.id, ...doc.data() }));
                    appData.sort((a, b) => new Date(b.date + 'T' + b.time) - new Date(a.date + 'T' + a.time));
                    refreshUI();
                }, (error) => {
                    statusEl.innerHTML = `<span class="w-2 h-2 rounded-full bg-red-500"></span> Sync Error`;
                });
            });
        }

        window.saveEntry = async (e) => {
            e.preventDefault();
            if (!currentUser) return;
            const { db, appId, firestoreUtils } = window;

            const editId = document.getElementById('edit-id').value;
            const data = {
                date: editId ? appData.find(x => x.id === editId).date : new Date().toISOString().split('T')[0],
                time: editId ? appData.find(x => x.id === editId).time : new Date().toLocaleTimeString('en-IN', { hour12: false, hour: '2-digit', minute: '2-digit' }),
                supplier: document.getElementById('inp-supplier').value.trim(),
                bill: parseFloat(document.getElementById('inp-bill').value) || 0,
                cash: parseFloat(document.getElementById('inp-cash').value) || 0,
                upi: parseFloat(document.getElementById('inp-upi').value) || 0,
                net: parseFloat(document.getElementById('inp-net').value) || 0
            };

            try {
                if (editId) {
                    await firestoreUtils.updateDoc(firestoreUtils.doc(db, 'artifacts', appId, 'users', currentUser.uid, 'purchases', editId), data);
                    showToast("Record Updated");
                } else {
                    await firestoreUtils.addDoc(firestoreUtils.collection(db, 'artifacts', appId, 'users', currentUser.uid, 'purchases'), data);
                    showToast("Saved to Cloud");
                }
                resetForm();
            } catch (err) { showToast("Error saving data"); }
        };

        window.confirmDelete = async () => {
            if (!deleteId || !currentUser) return;
            const { db, appId, firestoreUtils } = window;
            await firestoreUtils.deleteDoc(firestoreUtils.doc(db, 'artifacts', appId, 'users', currentUser.uid, 'purchases', deleteId));
            closeDeleteModal();
            showToast("Record Deleted");
        };

        function refreshUI() {
            updateDatalists();
            renderTodayDashboard();
            renderHistory();
            renderSupplierLedger();
            renderForecast();
        }

        function formatCurrency(n) { return new Intl.NumberFormat('en-IN', { style: 'currency', currency: 'INR', maximumFractionDigits: 0 }).format(n); }
        
        window.switchTab = (id) => {
            document.querySelectorAll('.tab-content').forEach(el => el.classList.remove('active'));
            document.querySelectorAll('.nav-btn').forEach(el => el.classList.remove('bg-ios-blue', 'text-white'));
            document.getElementById(id).classList.add('active');
            document.getElementById('nav-' + id).classList.add('bg-ios-blue', 'text-white');
        };

        window.renderTodayDashboard = () => {
            const todayStr = new Date().toISOString().split('T')[0];
            const filtered = appData.filter(d => d.date === todayStr);
            const total = filtered.reduce((a, b) => a + b.bill, 0);
            const paid = filtered.reduce((a, b) => a + (b.cash + b.upi + b.net), 0);
            document.getElementById('dash-today-total').innerText = formatCurrency(total);
            document.getElementById('dash-today-paid').innerText = formatCurrency(paid);
            document.getElementById('dash-today-pending').innerText = formatCurrency(total - paid);
            document.getElementById('current-date-display').innerText = new Date().toLocaleDateString('en-IN', { weekday: 'long', day: 'numeric', month: 'long' });
        };

        window.renderHistory = () => {
            const tbody = document.getElementById('history-table-body');
            const search = document.getElementById('hist-search').value.toLowerCase();
            const start = document.getElementById('hist-date-start').value;
            const end = document.getElementById('hist-date-end').value;
            
            tbody.innerHTML = '';
            let totalFiltered = 0;
            let pendingFiltered = 0;

            appData.filter(d => {
                const matchesSearch = d.supplier.toLowerCase().includes(search);
                const matchesStart = start ? d.date >= start : true;
                const matchesEnd = end ? d.date <= end : true;
                return matchesSearch && matchesStart && matchesEnd;
            }).forEach(d => {
                const paid = d.cash + d.upi + d.net;
                const pend = d.bill - paid;
                totalFiltered += d.bill;
                pendingFiltered += pend;

                const tr = document.createElement('tr');
                tr.className = "border-b border-gray-100 hover:bg-gray-50 transition-colors";
                tr.innerHTML = `
                    <td class="p-4 text-xs text-gray-400 font-mono">${d.date}</td>
                    <td class="p-4 font-semibold text-gray-800">${d.supplier}</td>
                    <td class="p-4 text-right font-medium">₹${d.bill}</td>
                    <td class="p-4 text-right text-green-600 font-medium">₹${paid}</td>
                    <td class="p-4 text-right font-bold ${pend > 0 ? 'text-red-500' : 'text-gray-300'}">₹${pend}</td>
                    <td class="p-4 text-center">
                        <div class="flex gap-2 justify-center">
                            <button onclick="editEntry('${d.id}')" class="w-8 h-8 rounded-full hover:bg-blue-50 text-blue-500 transition-all flex items-center justify-center"><i class="ph ph-pencil"></i></button>
                            <button onclick="openDeleteModal('${d.id}')" class="w-8 h-8 rounded-full hover:bg-red-50 text-red-400 transition-all flex items-center justify-center"><i class="ph ph-trash"></i></button>
                        </div>
                    </td>
                `;
                tbody.appendChild(tr);
            });
            document.getElementById('hist-total-sum').innerText = formatCurrency(totalFiltered);
            document.getElementById('hist-pending-sum').innerText = formatCurrency(pendingFiltered);
        };

        window.editEntry = (id) => {
            const item = appData.find(x => x.id === id);
            document.getElementById('edit-id').value = id;
            document.getElementById('inp-supplier').value = item.supplier;
            document.getElementById('inp-bill').value = item.bill;
            document.getElementById('inp-cash').value = item.cash;
            document.getElementById('inp-upi').value = item.upi;
            document.getElementById('inp-net').value = item.net;
            document.getElementById('btn-text').innerText = "Update Record";
            document.getElementById('cancel-edit').classList.remove('hidden');
            switchTab('today');
        };

        window.resetForm = () => {
            document.getElementById('entry-form').reset();
            document.getElementById('edit-id').value = '';
            document.getElementById('btn-text').innerText = "Save to Cloud";
            document.getElementById('cancel-edit').classList.add('hidden');
        };

        window.renderSupplierLedger = () => {
            const name = document.getElementById('ledger-select').value;
            const tbody = document.getElementById('ledger-body');
            const summary = document.getElementById('ledger-summary');
            const empty = document.getElementById('ledger-empty');
            tbody.innerHTML = '';

            if (!name) { summary.classList.add('hidden'); empty.classList.remove('hidden'); return; }
            summary.classList.remove('hidden'); empty.classList.add('hidden');

            const subset = appData.filter(d => d.supplier === name);
            let totalBill = 0, totalPaid = 0;

            subset.forEach(d => {
                const paid = d.cash + d.upi + d.net;
                const bal = d.bill - paid;
                totalBill += d.bill;
                totalPaid += paid;
                const tr = document.createElement('tr');
                tr.className = "border-b border-gray-100";
                tr.innerHTML = `<td class="p-4 text-xs">${d.date}</td><td class="p-4 text-right">₹${d.bill}</td><td class="p-4 text-right">₹${paid}</td><td class="p-4 text-right font-bold text-red-500">₹${bal}</td>`;
                tbody.appendChild(tr);
            });
            document.getElementById('led-total-bill').innerText = formatCurrency(totalBill);
            document.getElementById('led-total-paid').innerText = formatCurrency(totalPaid);
            document.getElementById('led-balance').innerText = formatCurrency(totalBill - totalPaid);
        };

        window.renderForecast = () => {
            const target = document.getElementById('fc-supplier-select').value;
            const subset = target === 'all' ? appData : appData.filter(d => d.supplier === target);
            const insights = document.getElementById('insights-list');
            insights.innerHTML = '';

            if (subset.length < 2) {
                document.getElementById('fc-next-week').innerText = "₹0";
                document.getElementById('fc-next-month').innerText = "₹0";
                insights.innerHTML = '<li><i class="ph ph-warning-circle text-orange-400"></i> Need at least 2 entries for projection.</li>';
                return;
            }

            // Simple Linear Projection: Average Daily Spend based on historical range
            const dates = subset.map(d => new Date(d.date).getTime());
            const minDate = Math.min(...dates);
            const maxDate = Math.max(...dates);
            const daysDiff = Math.max(1, (maxDate - minDate) / (1000 * 60 * 60 * 24));
            const totalSpend = subset.reduce((a, b) => a + b.bill, 0);
            const avgDaily = totalSpend / daysDiff;

            const nextWeek = avgDaily * 7;
            const nextMonth = avgDaily * 30;

            document.getElementById('fc-next-week').innerText = formatCurrency(nextWeek);
            document.getElementById('fc-next-month').innerText = formatCurrency(nextMonth);

            // Add Insights
            const topSupplier = [...new Set(appData.map(d => d.supplier))].map(s => ({
                name: s, total: appData.filter(x => x.supplier === s).reduce((a,b) => a + b.bill, 0)
            })).sort((a,b) => b.total - a.total)[0];

            insights.innerHTML += `<li><i class="ph ph-chart-line text-blue-500"></i> Daily average spend for ${target === 'all' ? 'everything' : target} is ${formatCurrency(avgDaily)}.</li>`;
            if (topSupplier) insights.innerHTML += `<li><i class="ph ph-crown text-yellow-500"></i> Biggest supplier by volume is <strong>${topSupplier.name}</strong>.</li>`;
        };

        function updateDatalists() {
            const sups = [...new Set(appData.map(d => d.supplier))].sort();
            document.getElementById('supplier-list').innerHTML = sups.map(s => `<option value="${s}">`).join('');
            const ls = document.getElementById('ledger-select');
            const fs = document.getElementById('fc-supplier-select');
            const curL = ls.value; const curF = fs.value;
            ls.innerHTML = '<option value="">Select Supplier</option>' + sups.map(s => `<option value="${s}">${s}</option>`).join('');
            fs.innerHTML = '<option value="all">All Suppliers Combined</option>' + sups.map(s => `<option value="${s}">${s}</option>`).join('');
            ls.value = curL; fs.value = curF;
        }

        window.openDeleteModal = (id) => { deleteId = id; document.getElementById('delete-modal').classList.remove('hidden'); };
        window.closeDeleteModal = () => { document.getElementById('delete-modal').classList.add('hidden'); };
        document.getElementById('confirm-delete-btn').onclick = () => window.confirmDelete();
        document.getElementById('entry-form').onsubmit = (e) => window.saveEntry(e);

        function showToast(m) {
            const t = document.getElementById('toast');
            document.getElementById('toast-msg').innerText = m;
            t.classList.remove('translate-x-[150%]');
            setTimeout(() => t.classList.add('translate-x-[150%]'), 3000);
        }

        startApp();
    </script>
</body>
</html>
